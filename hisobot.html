<!DOCTYPE html>
<html lang="uz">
  <head>
    <meta charset="UTF-8" />
    <title>ðŸ“Š Hisobotlar</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <!-- favicon -->
    <link
      rel="icon"
      type="image/png"
      href="https://peculiar-azure-xpdzzqfo3r.edgeone.app/Skrinshot_2026-01-03_175603-removebg-preview.png"
    />

    <style>
      :root {
        --bg: #020617;
        --card: #020617;
        --text: #e5e7eb;
        --muted: #94a3b8;
        --accent: #38bdf8;
        --border: #1e293b;
        --success: #22c55e;
        --danger: #ef4444;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        background: radial-gradient(circle at top, #020617, #000);
        color: var(--text);
        font-family: system-ui, sans-serif;
      }

      .wrap {
        max-width: 1200px;
        margin: auto;
        padding: 16px;
      }

      h1 {
        text-align: center;
        margin: 12px 0 16px;
      }

      /* TOP BAR */
      .topbar {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        margin-bottom: 14px;
      }

      button {
        padding: 10px 14px;
        border-radius: 12px;
        border: none;
        cursor: pointer;
        background: var(--accent);
        color: #000;
        font-weight: 700;
      }

      button.secondary {
        background: transparent;
        color: var(--text);
        border: 1px solid var(--border);
      }

      button.active {
        background: #0ea5e9;
        box-shadow: 0 0 0 2px rgba(56, 189, 248, 0.35);
      }

      input[type="date"] {
        padding: 10px 12px;
        border-radius: 12px;
        background: #020617;
        border: 1px solid var(--border);
        color: var(--text);
      }

      /* STATS */
      .stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 12px;
        margin-bottom: 16px;
      }

      .stat {
        background: rgba(2, 6, 23, 0.8);
        border: 1px solid var(--border);
        border-radius: 16px;
        padding: 14px;
        text-align: center;
      }

      .stat b {
        display: block;
        font-size: 22px;
        margin-top: 6px;
      }

      /* LOADING */
      .loading {
        display: none;
        align-items: center;
        justify-content: center;
        gap: 10px;
        color: var(--muted);
        margin: 20px 0;
      }

      .spinner {
        width: 22px;
        height: 22px;
        border: 3px solid var(--border);
        border-top-color: var(--accent);
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      /* TABLE */
      .table-wrap {
        overflow-x: auto;
        background: rgba(2, 6, 23, 0.75);
        border: 1px solid var(--border);
        border-radius: 16px;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        min-width: 900px;
      }

      th,
      td {
        padding: 12px;
        border-bottom: 1px dashed var(--border);
        font-size: 14px;
        text-align: left;
        white-space: nowrap;
      }

      th {
        color: var(--muted);
      }

      .done {
        color: var(--success);
        font-weight: 700;
      }

      .btn-deliver {
        background: var(--success);
        color: #000;
      }

      @media (max-width: 768px) {
        table {
          min-width: 760px;
        }
      }
    </style>
  </head>

  <body>
    <div class="wrap">
      <div class="topbar">
        <button onclick="goIndex()">â¬… Yangi buyurtma</button>
        <button id="btnToday" onclick="setMode('today')">ðŸ“… Bugun</button>
        <button id="btnAll" class="secondary" onclick="setMode('all')">
          ðŸ“† Barcha
        </button>
        <input type="date" id="datePick" onchange="pickDate()" />
      </div>

      <h1>ðŸ“Š Hisobotlar</h1>

      <!-- STATS -->
      <div class="stats">
        <div class="stat">ðŸ‘¥ Mijozlar<b id="sClients">0</b></div>
        <div class="stat">ðŸšš Yetkazildi<b id="sDelivered">0</b></div>
        <div class="stat">ðŸ’° Foyda<b id="sProfit">0</b></div>
      </div>

      <!-- LOADING -->
      <div class="loading" id="loading">
        <div class="spinner"></div>
        <span>Yuklanmoqda...</span>
      </div>

      <!-- TABLE -->
      <div class="table-wrap" id="tableWrap" style="display: none">
        <table>
          <thead>
            <tr>
              <th>Ism</th>
              <th>Telefon</th>
              <th>Sana</th>
              <th>Jami</th>
              <th>Toâ€˜langan</th>
              <th>Toâ€˜lov</th>
              <th>Holat</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </div>

    <script>
      const API = "https://gilam-yuvish-backend.onrender.com";
      let orders = [];
      let mode = "today";
      let selectedDate = "";

      function goIndex() {
        location.href = "index.html";
      }

      function formatDate(d) {
        return d ? new Date(d).toLocaleString("uz-UZ") : "";
      }

      function isToday(dateStr) {
        const d = new Date(dateStr);
        const now = new Date();
        return (
          d.getFullYear() === now.getFullYear() &&
          d.getMonth() === now.getMonth() &&
          d.getDate() === now.getDate()
        );
      }

      function isSameDate(dateStr, ymd) {
        return new Date(dateStr).toISOString().slice(0, 10) === ymd;
      }

      function setMode(m) {
        mode = m;
        selectedDate = "";
        datePick.value = "";
        btnToday.classList.toggle("active", m === "today");
        btnAll.classList.toggle("active", m === "all");
        render();
      }

      function pickDate() {
        selectedDate = datePick.value;
        mode = "";
        btnToday.classList.remove("active");
        btnAll.classList.remove("active");
        render();
      }

      async function load() {
        loading.style.display = "flex";
        tableWrap.style.display = "none";

        const r = await fetch(API + "/orders");
        orders = await r.json();

        setTimeout(() => {
          loading.style.display = "none";
          tableWrap.style.display = "block";
          render();
        }, 300);
      }

      function render() {
        tbody.innerHTML = "";

        let list = orders;

        if (selectedDate) {
          list = orders.filter((o) => isSameDate(o.createdAt, selectedDate));
        } else if (mode === "today") {
          list = orders.filter((o) => isToday(o.createdAt));
        }

        list.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));

        sClients.textContent = list.length;
        sDelivered.textContent = list.filter((o) => o.delivered).length;
        sProfit.textContent = list
          .reduce((s, o) => s + (Number(o.total) - Number(o.paid || 0)), 0)
          .toLocaleString();

        list.forEach((o) => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${o.name || "â€”"}</td>
            <td>${o.phone || "â€”"}</td>
            <td>${formatDate(o.createdAt)}</td>
            <td>${Number(o.total).toLocaleString()}</td>
            <td>${Number(o.paid || 0).toLocaleString()}</td>
            <td>${o.paymentType || "â€”"}</td>
            <td class="${o.delivered ? "done" : ""}">
              ${o.delivered ? "Yetkazildi" : "Kutilmoqda"}
            </td>
            <td>
              ${
                o.delivered
                  ? ""
                  : `<button class="btn-deliver" onclick="deliver('${o._id}')">
                       ðŸšš Yetkazildi
                     </button>`
              }
            </td>
          `;
          tbody.appendChild(tr);
        });
      }

      async function deliver(id) {
        await fetch(API + "/orders/" + id + "/deliver", {
          method: "PUT",
        });
        load();
      }

      load();
    </script>
  </body>
</html>
