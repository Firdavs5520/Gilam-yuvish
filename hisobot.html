<!DOCTYPE html>
<html lang="uz">
  <head>
    <meta charset="UTF-8" />
    <title>ğŸ“Š Cheklar tarixi</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <style>
      :root {
        --bg: #020617;
        --card: rgba(2, 6, 23, 0.75);
        --text: #e5e7eb;
        --muted: #94a3b8;
        --accent: #38bdf8;
        --border: #1e293b;
        --danger: #ef4444;
        --success: #22c55e;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        background: radial-gradient(circle at top, #020617, #000);
        color: var(--text);
        font-family: system-ui, sans-serif;
      }

      .wrap {
        max-width: 1100px;
        margin: auto;
        padding: 20px;
      }

      h1 {
        margin-top: 0;
        text-align: center;
      }

      .controls {
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
        margin-bottom: 16px;
        justify-content: center;
      }

      input,
      button {
        padding: 12px;
        border-radius: 10px;
        font-size: 15px;
        border: 1px solid var(--border);
        background: transparent;
        color: var(--text);
      }

      button {
        cursor: pointer;
        border: none;
        font-weight: 600;
      }

      .primary {
        background: linear-gradient(135deg, var(--accent), #0ea5e9);
        color: #000;
      }

      .success {
        background: var(--success);
        color: #000;
      }

      .danger {
        background: var(--danger);
        color: #000;
      }

      .grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
        gap: 16px;
      }

      .card {
        background: var(--card);
        border: 1px solid var(--border);
        border-radius: 16px;
        padding: 16px;
        position: relative;
      }

      .badge {
        position: absolute;
        top: 12px;
        right: 12px;
        background: var(--success);
        color: #000;
        font-size: 12px;
        padding: 4px 8px;
        border-radius: 20px;
      }

      .name {
        font-size: 17px;
        font-weight: 700;
      }

      .small {
        color: var(--muted);
        font-size: 14px;
        margin-top: 2px;
      }

      .items {
        margin-top: 8px;
        font-size: 14px;
      }

      .items div {
        display: flex;
        justify-content: space-between;
        border-bottom: 1px dashed var(--border);
        padding: 4px 0;
      }

      .actions {
        display: flex;
        gap: 8px;
        margin-top: 10px;
      }

      @media (max-width: 700px) {
        .controls {
          flex-direction: column;
        }
      }
      .back-btn {
        margin: 10px auto 20px;
        display: block;
        max-width: 260px;
      }
    </style>
  </head>

  <body>
    <button class="primary back-btn" onclick="goBack()">
      ğŸ” Yangi buyurtmaga qaytish
    </button>

    <div class="wrap">
      <h1>ğŸ“Š Cheklar tarixi</h1>

      <!-- SARALASH -->
      <div class="controls">
        <button class="primary" onclick="showAll()">ğŸ“‚ Barcha cheklar</button>
        <button class="primary" onclick="showToday()">
          ğŸ“… Bugungi cheklar
        </button>
        <input id="datePick" type="date" />
        <button class="primary" onclick="filterByDate()">
          ğŸ“† Tanlangan kun
        </button>
      </div>

      <!-- LIST -->
      <div id="grid" class="grid"></div>
    </div>

    <script>
      const API = "https://gilam-yuvish-backend.onrender.com";
      let orders = [];

      async function load() {
        const res = await fetch(API + "/orders");
        orders = await res.json();
        render(orders);
      }

      function render(list) {
        grid.innerHTML = "";

        if (!list.length) {
          grid.innerHTML = "<div class='small'>Cheklar topilmadi</div>";
          return;
        }

        list
          .sort((a, b) => new Date(b.date) - new Date(a.date))
          .forEach((o) => {
            const el = document.createElement("div");
            el.className = "card";

            el.innerHTML = `
              ${o.delivered ? `<div class="badge">Yetkazildi</div>` : ""}
              <div class="name">${o.name || "â€”"}</div>
              <div class="small">ğŸ“ ${o.phone || "â€”"}</div>
              <div class="small">ğŸ“… ${o.date || ""}</div>

              <div class="items">
                ${o.items
                  .map(
                    (i) =>
                      `<div><span>${i.l}Ã—${i.w}</span><span>${Number(
                        i.sum
                      ).toLocaleString()}</span></div>`
                  )
                  .join("")}
              </div>

              <b>ğŸ’° Jami: ${Number(o.total || 0).toLocaleString()} soâ€˜m</b>
              <div>Toâ€˜langan: ${Number(o.paid || 0).toLocaleString()}</div>

              <div class="actions">
                ${
                  !o.delivered
                    ? `<button class="success" onclick="deliver('${
                        o._id || o.id
                      }')">ğŸšš Yetkazildi</button>`
                    : ""
                }
                <button class="danger" onclick="removeOrder('${
                  o._id || o.id
                }')">ğŸ—‘ Oâ€˜chirish</button>
              </div>
            `;
            grid.appendChild(el);
          });
      }

      function showAll() {
        render(orders);
      }

      function showToday() {
        const today = new Date().toLocaleDateString();
        render(orders.filter((o) => o.date && o.date.startsWith(today)));
      }

      function filterByDate() {
        if (!datePick.value) return;
        const d = new Date(datePick.value).toLocaleDateString();
        render(orders.filter((o) => o.date && o.date.startsWith(d)));
      }

      async function deliver(id) {
        await fetch(API + "/orders/" + id + "/deliver", {
          method: "PUT",
        });
        load();
      }

      async function removeOrder(id) {
        if (!confirm("Chek oâ€˜chirilsinmi?")) return;
        await fetch(API + "/orders/" + id, { method: "DELETE" });
        load();
      }

      load();

      function goBack() {
        window.location.href = "index.html";
      }
    </script>
  </body>
</html>
