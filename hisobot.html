<!DOCTYPE html>
<html lang="uz">
  <head>
    <meta charset="UTF-8" />
    <title>ðŸ“Š Hisobotlar</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <style>
      :root {
        --bg: #020617;
        --card: #020617;
        --text: #e5e7eb;
        --muted: #94a3b8;
        --accent: #38bdf8;
        --border: #1e293b;
        --success: #22c55e;
      }
      * {
        box-sizing: border-box;
      }
      body {
        margin: 0;
        background: radial-gradient(circle at top, #020617, #000);
        color: var(--text);
        font-family: system-ui, sans-serif;
      }
      .wrap {
        max-width: 1200px;
        margin: auto;
        padding: 20px;
      }
      h1 {
        text-align: center;
        margin-bottom: 20px;
      }

      /* SUMMARY */
      .stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 12px;
        margin-bottom: 20px;
      }
      .stat {
        background: rgba(2, 6, 23, 0.8);
        border: 1px solid var(--border);
        border-radius: 16px;
        padding: 16px;
        text-align: center;
      }
      .stat b {
        font-size: 22px;
        display: block;
        margin-top: 6px;
      }

      /* FILTER */
      .filter {
        display: flex;
        gap: 10px;
        margin-bottom: 14px;
        flex-wrap: wrap;
      }
      button {
        padding: 10px 14px;
        border-radius: 12px;
        border: none;
        cursor: pointer;
        background: var(--accent);
        color: #000;
        font-weight: 700;
      }
      button.secondary {
        background: transparent;
        color: var(--text);
        border: 1px solid var(--border);
      }

      /* TABLE */
      .table-wrap {
        overflow: auto;
        background: rgba(2, 6, 23, 0.75);
        border: 1px solid var(--border);
        border-radius: 16px;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        min-width: 900px;
      }
      th,
      td {
        padding: 12px;
        border-bottom: 1px dashed var(--border);
        font-size: 14px;
        text-align: left;
      }
      th {
        color: var(--muted);
      }
      .done {
        color: var(--success);
        font-weight: 700;
      }

      @media (max-width: 768px) {
        table {
          min-width: 700px;
        }
      }
    </style>
  </head>

  <body>
    <div class="wrap">
      <h1>ðŸ“Š Hisobotlar</h1>

      <!-- SUMMARY -->
      <div class="stats">
        <div class="stat">ðŸ‘¥ Bugungi mijozlar<b id="sClients">0</b></div>
        <div class="stat">ðŸšš Yetkazildi<b id="sDelivered">0</b></div>
        <div class="stat">ðŸ’° Bugungi foyda<b id="sProfit">0</b></div>
      </div>

      <!-- FILTER -->
      <div class="filter">
        <button onclick="setMode('today')">ðŸ“… Bugun</button>
        <button class="secondary" onclick="setMode('all')">
          ðŸ“† Barcha kunlar
        </button>
        <button class="secondary" onclick="goBack()">â¬… Orqaga</button>
      </div>

      <!-- TABLE -->
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>Ism</th>
              <th>Telefon</th>
              <th>Sana</th>
              <th>Jami</th>
              <th>Toâ€˜langan</th>
              <th>Holat</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </div>

    <script>
      const API = "https://gilam-yuvish-backend.onrender.com";
      let orders = [];
      let mode = "today";

      function goBack() {
        location.href = "index.html";
      }

      function isToday(dateStr) {
        const d = new Date(dateStr);
        const t = new Date();
        return d.toDateString() === t.toDateString();
      }

      function setMode(m) {
        mode = m;
        render();
      }

      async function load() {
        const r = await fetch(API + "/orders");
        orders = await r.json();
        render();
      }

      function render() {
        const tbody = document.getElementById("tbody");
        tbody.innerHTML = "";

        let list =
          mode === "today" ? orders.filter((o) => isToday(o.date)) : orders;

        let clients = list.length;
        let delivered = list.filter((o) => o.delivered).length;
        let profit = list.reduce(
          (s, o) => s + (Number(o.total) - Number(o.paid || 0)),
          0
        );

        sClients.textContent = clients;
        sDelivered.textContent = delivered;
        sProfit.textContent = profit.toLocaleString();

        list.sort((a, b) => new Date(b.date) - new Date(a.date));

        list.forEach((o) => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
        <td>${o.name || "â€”"}</td>
        <td>${o.phone || "â€”"}</td>
        <td>${o.date || ""}</td>
        <td>${Number(o.total).toLocaleString()}</td>
        <td>${Number(o.paid || 0).toLocaleString()}</td>
        <td class="${o.delivered ? "done" : ""}">
          ${o.delivered ? "Yetkazildi" : "Kutilmoqda"}
        </td>
        <td>
          ${
            o.delivered
              ? ""
              : `<button onclick="deliver('${o._id || o.id}')">ðŸšš</button>`
          }
        </td>
      `;
          tbody.appendChild(tr);
        });
      }

      async function deliver(id) {
        await fetch(API + "/orders/" + id + "/deliver", { method: "PUT" });
        load();
      }

      load();
    </script>
  </body>
</html>
